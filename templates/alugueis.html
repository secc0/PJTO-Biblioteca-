<!DOCTYPE html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <title>Meus Alugu√©is</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='css/alugueis.css') }}"
    />
    <style>
      .multa { color: red; font-weight: bold; margin-top: 5px; }
      .avaliacao-item { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
      .aluguel-item { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; }
      .aluguel-item img { max-width: 100px; margin-right: 10px; vertical-align: middle; }
      .info { display: inline-block; vertical-align: middle; }
      .avaliacao-item button { margin-right: 5px; }
    </style>
  </head>
  <body>
    <h1>Meus Alugu√©is</h1>
    <div id="alugueis-container"></div>

    <script>
      async function carregarAlugueis() {
        try {
          const response = await fetch("/alugueis/meus-alugueis");
          const dados = await response.json();

          const container = document.getElementById("alugueis-container");
          container.innerHTML = "";
          container.className = "alugueis";

          dados.forEach((aluguel) => {
            const div = document.createElement("div");
            div.className = "aluguel-item";

            // ‚ö†Ô∏è Garantir que id_livro esteja presente
            const idLivro = aluguel.livro_id // fallback

            div.innerHTML = `
              <img src="${aluguel.imagem}" alt="${aluguel.titulo}">
              <div class="info"> 
                <h3>${aluguel.titulo}</h3>
                <p><strong>Data do Aluguel:</strong> ${aluguel.data_aluguel}</p>
                <p><strong>Data de Devolu√ß√£o:</strong> ${aluguel.data_devolucao ?? "N√£o devolvido"}</p>
                <p><strong>Status:</strong> ${aluguel.devolvido ? "Devolvido" : "Em posse"}</p>
                ${aluguel.multa ? `<p class="multa">Multa por atraso na devolu√ß√£o: R$ 100,00</p>` : ""}
                ${!aluguel.devolvido ? `<button onclick="devolverLivro(${aluguel.id}, ${idLivro}, '${aluguel.titulo.replace(/'/g, "\\'")}')">Devolver Livro</button>` : ""}
              </div>
            `;

            container.appendChild(div);
          });
        } catch (erro) {
          console.error("Erro ao carregar alugu√©is:", erro);
        }
      }

      async function devolverLivro(idAluguel, idLivro, titulo) {
        if (!confirm("Tem certeza que deseja devolver este livro?")) return;

        try {
          const resposta = await fetch(`/alugueis/devolver/${idAluguel}`, { method: "POST" });

          if (resposta.ok) {
            alert("Livro devolvido com sucesso!");
            mostrarOpcoesAvaliacao(idLivro, titulo);
          } else {
            const erro = await resposta.json();
            alert("Erro ao devolver livro: " + erro.erro);
          }
        } catch (e) {
          console.error("Erro ao enviar devolu√ß√£o:", e);
          alert("Erro interno ao devolver livro.");
        }
      }

      function mostrarOpcoesAvaliacao(idLivro, titulo) {
        if (!idLivro) return console.error("idLivro indefinido!");

        const container = document.getElementById("alugueis-container");
        const div = document.createElement("div");
        div.className = "avaliacao-item";

        const h3 = document.createElement("h3");
        h3.textContent = `Avalie o livro: ${titulo}`;
        div.appendChild(h3);

        const btnLike = document.createElement("button");
        btnLike.textContent = "üëç Gostei";
        btnLike.addEventListener("click", () => avaliarLivro(idLivro, 1));
        div.appendChild(btnLike);

        const btnDislike = document.createElement("button");
        btnDislike.textContent = "üëé N√£o gostei";
        btnDislike.addEventListener("click", () => avaliarLivro(idLivro, -1));
        div.appendChild(btnDislike);

        container.prepend(div);
      }

      function avaliarLivro(idLivro, avaliacao) {
        if (!idLivro) return console.error("idLivro indefinido!");

        fetch("/avaliacoes/avaliar", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ id_livro: idLivro, avaliacao: avaliacao })
        })
        .then(r => r.json())
        .then(dados => {
          console.log("Resposta do back:", dados);
          alert(dados.mensagem || dados.erro);
          carregarAlugueis(); // atualiza lista sem reload completo
        })
        .catch(err => console.error("Erro ao avaliar:", err));
      }

      carregarAlugueis();
    </script>
  </body>
</html>
